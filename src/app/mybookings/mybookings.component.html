<div class="min-h-screen bg-slate-50 text-slate-900" data-page>
  <!-- Header -->
  <app-header></app-header>

  <main class="pt-20 pb-14" data-auto-reveal>
    <section class="w-full px-4">
      <div class="flex items-end justify-between gap-3 mb-5">
        <div>
          <h1 class="text-2xl font-semibold">My Bookings</h1>
          <p class="text-slate-600 text-sm">All passes saved in this browser.</p>
        </div>
        <a routerLink="/" class="text-sm text-accent hover:brightness-110 underline underline-offset-4">Back to Home</a>
      </div>

      <!-- Loading -->
      <div *ngIf="loading()" class="p-4 rounded-xl border border-slate-200 bg-white shadow-sm">
        Loading your bookings…
      </div>

      <!-- Not logged in -->
      <div *ngIf="!loading() && !hasLogin()" class="p-5 rounded-xl border border-slate-200 bg-white shadow-sm">
        <p class="text-slate-700">You need to sign in to view your bookings.</p>
        <button
          class="mt-3 px-4 py-2 rounded-lg bg-accent text-blend font-bold hover:brightness-110"
          (click)="goLogin($event)"
        >
          Sign In / Register
        </button>
      </div>

      <!-- Error -->
      <div *ngIf="!loading() && errorMsg()" class="p-4 rounded-xl border border-red-200 bg-red-50 text-red-700">
        {{ errorMsg() }}
      </div>

      <!-- Empty -->
      <div *ngIf="!loading() && hasLogin() && items().length === 0" class="p-5 rounded-xl border border-slate-200 bg-white shadow-sm">
        <p class="text-slate-700">No bookings yet.</p>
        <a routerLink="/" fragment="pesan" class="inline-block mt-3 px-4 py-2 rounded-lg bg-accent text-blend font-bold hover:brightness-110">
          Book a Pass
        </a>
      </div>

      <!-- List -->
      <div *ngIf="!loading() && hasLogin() && items().length > 0" class="grid gap-4">
        <div
          *ngFor="let b of items()"
          class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden"
        >
          <div class="p-4 md:p-5">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="flex items-center gap-2">
                  <span class="text-xs px-2 py-0.5 rounded bg-slate-100 text-slate-700 border border-slate-200">Code</span>
                  <span class="font-mono text-sm font-bold">{{ b.code }}</span>
                </div>
                <div class="mt-1 text-slate-600 text-xs">
                  Created {{ b.createdAt | date:'dd/MM/yyyy, HH:mm' }}
                </div>
              </div>
              <div class="text-right">
                <span
                  class="inline-flex items-center text-xs px-2 py-1 rounded border"
                  [ngClass]="{
                    'bg-emerald-50 text-emerald-700 border-emerald-200': (b.status || '').toLowerCase() === 'paid',
                    'bg-amber-50 text-amber-700 border-amber-200': (b.status || '').toLowerCase() !== 'paid'
                  }"
                >
                  {{ (b.status || 'pending') | uppercase }}
                </span>
              </div>
            </div>

            <div class="mt-3 grid sm:grid-cols-2 gap-3">
              <div class="text-slate-700 text-sm">
                <div><span class="font-semibold">Forest:</span> {{ forestLabel(b.forest) }}</div>
                <div><span class="font-semibold">Pickup:</span> {{ b.pickup }}</div>
                <div><span class="font-semibold">Dates:</span> {{ fmtDateRange(b.dateIn, b.dateOut, b.dayTrip) }}</div>
              </div>
              <div class="text-slate-700 text-sm">
                <div><span class="font-semibold">Guests:</span> {{ b.guests }}</div>
                <div><span class="font-semibold">Package:</span> {{ pkgLabel(b.pkg) }}</div>
                <div><span class="font-semibold">Total:</span> {{ fmtIDR(b.subtotal || 0) }}</div>
                <div *ngIf="(b.status || '').toLowerCase() === 'paid'">
                  <span class="font-semibold">Payment:</span> {{ (b.paidMethod || 'CARD') | uppercase }}
                </div>
              </div>
            </div>
          </div>

          <!-- footer actions -->
          <div class="px-4 md:px-5 py-3 bg-slate-50 border-t border-slate-200 flex justify-end gap-2">
            <button class="px-3 py-2 rounded-lg border border-slate-200 text-slate-700 hover:bg-white" (click)="openDetail($event, b)">Details</button>
            <a routerLink="/" fragment="pesan" class="px-3 py-2 rounded-lg border border-slate-200 text-slate-700 hover:bg-white">Book Again</a>
            <button
              *ngIf="(b.status || '').toLowerCase() !== 'paid'"
              class="px-3 py-2 rounded-lg bg-emerald-600 text-white font-bold hover:brightness-110 disabled:opacity-60 disabled:cursor-not-allowed"
              [disabled]="payingId() === b.id"
              (click)="payNow($event, b)"
            >
              {{ payingId() === b.id ? 'Processing...' : 'Pay Now' }}
            </button>
          </div>
        </div>
      </div>

      <!-- ===== Modal: Booking Details ===== -->
      <div *ngIf="showDetailModal()" class="fixed inset-0 z-50" aria-modal="true" role="dialog">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" (click)="closeDetail()"></div>
        <div class="relative mx-auto max-w-3xl w-[calc(100%-2rem)] mt-12 bg-white rounded-2xl p-6 shadow-xl border border-slate-200 max-h-[85vh] overflow-y-auto">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h3 class="text-lg font-bold text-slate-900">Booking Details</h3>
              <p class="text-slate-600 text-sm mt-1">Code: <span class="font-mono">{{ detailTarget()?.code }}</span></p>
            </div>
            <button class="text-slate-400 hover:text-slate-600" aria-label="Close" (click)="closeDetail()">✕</button>
          </div>

          <div class="mt-4 grid md:grid-cols-2 gap-4">
            <div class="rounded-lg bg-slate-50 border border-slate-200 p-3 text-base text-slate-800">
              <div class="font-semibold mb-2">Summary</div>
              <div><span class="text-slate-600">Status:</span> {{ (detailTarget()?.status || 'pending') | uppercase }} <span class="text-slate-600">• Created:</span> {{ formatDate(detailTarget()?.createdAt || 0) }}</div>
              <div><span class="text-slate-600">Under:</span> {{ detailTarget()?.email }}</div>
              <div><span class="text-slate-600">Forest:</span> {{ forestLabel(detailTarget()?.forest || '') }}</div>
              <div><span class="text-slate-600">Pickup:</span> {{ detailTarget()?.pickup }}</div>
              <div><span class="text-slate-600">Dates:</span> {{ fmtDateRange(detailTarget()?.dateIn || '', detailTarget()?.dateOut || '', detailTarget()?.dayTrip) }}</div>
              <div class="flex items-center gap-2">
                <span class="text-slate-600">Guests:</span>
                <span class="font-semibold">{{ detailTarget()?.guests }} pax</span>
              </div>
              <div class="flex items-center gap-2 mt-1">
                <span class="text-slate-600">Package:</span>
                <span class="inline-flex items-center px-2 py-1 rounded-full bg-emerald-600 text-white text-xs font-bold tracking-wide uppercase">{{ pkgLabel(detailTarget()?.pkg || '') }}</span>
              </div>
              <div class="mt-1">
                <span class="text-slate-600">Extras:</span>
                <span class="inline-flex items-center gap-2">
                  <span class="px-2 py-0.5 rounded bg-slate-200 text-slate-700 text-xs">Transport: {{ detailTarget()?.needTransport ? 'Yes' : 'No' }}</span>
                  <span class="px-2 py-0.5 rounded bg-slate-200 text-slate-700 text-xs">Lodging: {{ detailTarget()?.needLodging ? 'Yes' : 'No' }}</span>
                </span>
              </div>
            </div>

            <div class="rounded-lg bg-slate-50 border border-slate-200 p-3 text-sm text-slate-700">
              <div class="font-semibold text-slate-700 mb-1">Cost Breakdown</div>
              <div class="grid grid-cols-2 gap-y-1">
                <div>Pass</div>
                <div class="text-right">{{ fmtIDR(calcPricing(detailTarget())?.passCost || 0) }}</div>
                <div>Transport</div>
                <div class="text-right">{{ fmtIDR(calcPricing(detailTarget())?.transportCost || 0) }}</div>
                <div>Lodging</div>
                <div class="text-right">{{ fmtIDR(calcPricing(detailTarget())?.lodgingCost || 0) }}</div>
              </div>
              <div class="mt-2 text-[12px] text-slate-500">
                Total: <span class="font-semibold text-slate-700">{{ fmtIDR((detailTarget()?.subtotal) || (calcPricing(detailTarget())?.total || 0)) }}</span>
              </div>
            </div>
          </div>

          <div class="mt-4 rounded-lg bg-slate-50 border border-slate-200 p-3" *ngIf="(detailPayments() || []).length > 0">
            <div class="text-sm font-semibold text-slate-700 mb-1">Payments</div>
            <div class="grid gap-2 text-sm text-slate-700">
              <div *ngFor="let p of detailPayments()" class="grid grid-cols-2">
                <div>Method</div><div class="text-right">{{ (p.method || 'CARD') | uppercase }}</div>
                <div>Amount</div><div class="text-right">{{ fmtIDR(p.amount || 0) }}</div>
                <div>Status</div><div class="text-right">{{ (p.status || 'paid') | uppercase }}</div>
                <div>Paid At</div><div class="text-right">{{ formatDate(p.createdAt || 0) }}</div>
              </div>
            </div>
          </div>

          <div class="mt-5 flex justify-end">
            <button class="px-4 py-2 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50" (click)="closeDetail()">Close</button>
          </div>
        </div>
      </div>
      <!-- ===== Modal: Pay Confirmation ===== -->
      <div *ngIf="showPayModal()" class="fixed inset-0 z-50" aria-modal="true" role="dialog">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" (click)="closePayModal()"></div>
        <div class="relative mx-auto max-w-lg w-[calc(100%-2rem)] mt-10 md:mt-16 bg-white rounded-2xl p-6 shadow-xl border border-slate-200 max-h-[85vh] overflow-y-auto">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h3 class="text-lg font-bold text-slate-900">Confirm Payment</h3>
              <p class="text-slate-600 text-sm mt-1">Please review before paying.</p>
            </div>
            <button class="text-slate-400 hover:text-slate-600" aria-label="Close" (click)="closePayModal()">✕</button>
          </div>

          <div class="mt-4 rounded-lg bg-slate-50 border border-slate-200 p-3">
            <div class="text-xs font-semibold text-slate-700 mb-1">Summary</div>
            <pre class="text-xs text-slate-700 whitespace-pre-wrap">Code     : {{ payTarget()?.code }}
Under    : {{ payTarget()?.email }}

Forest   : {{ forestLabel(payTarget()?.forest || '') }}
Pickup   : {{ payTarget()?.pickup }}
Dates    : {{ fmtDateRange(payTarget()?.dateIn || '', payTarget()?.dateOut || '', payTarget()?.dayTrip) }}
Guests   : {{ payTarget()?.guests }} | Package: {{ pkgLabel(payTarget()?.pkg || '') }}
            </pre>
            <div class="mt-2 text-xs text-slate-700">
              <div class="font-semibold mb-1">Cost Breakdown</div>
              <div class="grid grid-cols-2">
                <div>Pass</div>
                <div class="text-right">{{ fmtIDR(calcPricing(payTarget())?.passCost || 0) }}</div>
                <div>Transport</div>
                <div class="text-right">{{ fmtIDR(calcPricing(payTarget())?.transportCost || 0) }}</div>
                <div>Lodging</div>
                <div class="text-right">{{ fmtIDR(calcPricing(payTarget())?.lodgingCost || 0) }}</div>
              </div>
            </div>
          </div>

          <!-- Payment methods -->
          <div class="mt-4">
            <div class="text-xs font-semibold text-slate-700 mb-2">Choose Payment Method</div>
            <div class="grid sm:grid-cols-2 gap-2">
              <!-- Card -->
              <label class="pay-option flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer"
                [ngClass]="{ 'selected': payMethod() === 'CARD' }">
                <input type="radio" name="mbPayMethod" [checked]="payMethod() === 'CARD'" (change)="setPayMethod('CARD')" class="sr-only">
                <span class="inline-flex items-center gap-2">
                  <span class="inline-flex items-center -space-x-2">
                    <span class="w-6 h-4 rounded bg-[#1a1f71]"></span>
                    <span class="w-6 h-4 rounded bg-[#eb001b]"></span>
                  </span>
                  <span class="text-sm text-slate-800">Credit/Debit Card</span>
                </span>
              </label>
              <!-- PayPal -->
              <label class="pay-option flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer"
                [ngClass]="{ 'selected': payMethod() === 'PAYPAL' }">
                <input type="radio" name="mbPayMethod" [checked]="payMethod() === 'PAYPAL'" (change)="setPayMethod('PAYPAL')" class="sr-only">
                <span class="inline-flex items-center gap-2">
                  <span class="w-6 h-4 rounded bg-[#003087]"></span>
                  <span class="text-sm text-slate-800">PayPal</span>
                </span>
              </label>
              <!-- Bank Transfer -->
              <label class="pay-option flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer"
                [ngClass]="{ 'selected': payMethod() === 'BANK' }">
                <input type="radio" name="mbPayMethod" [checked]="payMethod() === 'BANK'" (change)="setPayMethod('BANK')" class="sr-only">
                <span class="inline-flex items-center gap-2">
                  <span class="w-6 h-4 rounded bg-slate-700 grid place-items-center text-[10px] text-white">VA</span>
                  <span class="text-sm text-slate-800">Bank Transfer / VA</span>
                </span>
              </label>
              <!-- E-Wallet -->
              <label class="pay-option flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer"
                [ngClass]="{ 'selected': payMethod() === 'EWALLET' }">
                <input type="radio" name="mbPayMethod" [checked]="payMethod() === 'EWALLET'" (change)="setPayMethod('EWALLET')" class="sr-only">
                <span class="inline-flex items-center gap-2">
                  <span class="w-6 h-4 rounded bg-[#00AAE4]"></span>
                  <span class="text-sm text-slate-800">E‑Wallet</span>
                </span>
              </label>
            </div>
          </div>

          <div class="mt-5 flex items-center justify-between">
            <div class="text-sm text-slate-700">
              <span class="font-semibold">Total:</span>
              <span class="font-bold">{{ fmtIDR((payTarget()?.subtotal) || (calcPricing(payTarget())?.total || 0)) }}</span>
            </div>
            <div class="flex gap-2">
              <button class="px-4 py-2 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50" (click)="closePayModal()">Cancel</button>
              <button class="px-4 py-2 rounded-lg bg-emerald-600 text-white font-bold hover:brightness-110 disabled:opacity-60 disabled:cursor-not-allowed"
                [disabled]="payingId() === (payTarget()?.id || -1)"
                (click)="confirmPay($event)">
                {{ payingId() === (payTarget()?.id || -1) ? 'Processing...' : 'Confirm & Pay' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>
