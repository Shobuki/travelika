<!doctype html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Travelika — Masuk / Daftar</title>
  <meta name="theme-color" content="#041b18" />
  <link rel="icon" href="/favicon.ico" />
  <!-- Tailwind CDN (cukup untuk dev) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { blend: '#041b18', accent: '#138374' },
          boxShadow: { brand: '0 10px 30px rgba(0,0,0,.25)' }
        }
      }
    }
  </script>
  <!-- Dexie (IndexedDB wrapper) -->
  <script src="https://cdn.jsdelivr.net/npm/dexie@4/dist/dexie.min.js"></script>
</head>

<body class="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 text-slate-900 ">
  <div data-include="/components/header.html"></div>

  <main class="max-w-screen-sm mx-auto px-4 py-10 mt-20 md:mt-24">
    <div class="text-center mb-6">
      <h1 class="text-2xl font-bold">Masuk / Daftar</h1>
      <p class="text-slate-600">Akun disimpan di <em>IndexedDB</em> di browser Anda.</p>
    </div>

    <div class="bg-white border rounded-2xl shadow-brand p-5 space-y-6 mb-20">
      <!-- Toggle -->
      <div class="flex gap-2 p-1 bg-slate-100 rounded-xl">
        <button id="tabLogin"
          class="flex-1 py-2 rounded-lg font-semibold bg-white shadow active:scale-[.99]">Masuk</button>
        <button id="tabRegister" class="flex-1 py-2 rounded-lg font-semibold hover:bg-white/70">Daftar</button>
      </div>

      <!-- Alerts -->
      <div id="alert" class="hidden rounded-lg p-3 text-sm"></div>

      <!-- LOGIN -->
      <form id="formLogin" class="grid gap-3">
        <div class="grid gap-1">
          <label for="loginEmail" class="text-sm text-slate-600">Email</label>
          <input id="loginEmail" type="email" class="w-full rounded-lg border px-3 py-2" placeholder="nama@domain.com"
            required />
        </div>
        <div class="grid gap-1">
          <label for="loginPass" class="text-sm text-slate-600">Kata Sandi</label>
          <div class="relative">
            <input id="loginPass" type="password" class="w-full rounded-lg border px-3 py-2 pr-10"
              placeholder="••••••••" required />
            <button type="button" data-toggle="loginPass"
              class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 text-sm">lihat</button>
          </div>
        </div>
        <div class="flex items-center justify-between">
          <label class="text-sm text-slate-600"><input id="remember" type="checkbox" class="mr-2 accent-accent">Ingat
            saya</label>
          <a href="#" class="text-sm text-accent opacity-80 pointer-events-none">Lupa sandi?</a>
        </div>
        <button class="mt-2 bg-accent text-blend font-bold rounded-xl px-4 py-2 hover:brightness-110">Masuk</button>
      </form>

      <!-- REGISTER -->
      <form id="formRegister" class="grid gap-3 hidden">
        <div class="grid gap-1">
          <label for="regName" class="text-sm text-slate-600">Nama Lengkap</label>
          <input id="regName" type="text" class="w-full rounded-lg border px-3 py-2" placeholder="Nama kamu" required />
        </div>
        <div class="grid gap-1">
          <label for="regEmail" class="text-sm text-slate-600">Email</label>
          <input id="regEmail" type="email" class="w-full rounded-lg border px-3 py-2" placeholder="nama@domain.com"
            required />
        </div>
        <div class="grid gap-1">
          <label for="regPass" class="text-sm text-slate-600">Kata Sandi</label>
          <div class="relative">
            <input id="regPass" type="password" class="w-full rounded-lg border px-3 py-2 pr-10" minlength="6"
              placeholder="Minimal 6 karakter" required />
            <button type="button" data-toggle="regPass"
              class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 text-sm">lihat</button>
          </div>
        </div>
        <div class="grid gap-1">
          <label for="regPass2" class="text-sm text-slate-600">Ulangi Kata Sandi</label>
          <div class="relative">
            <input id="regPass2" type="password" class="w-full rounded-lg border px-3 py-2 pr-10" minlength="6"
              placeholder="Ulangi kata sandi" required />
            <button type="button" data-toggle="regPass2"
              class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 text-sm">lihat</button>
          </div>
        </div>
        <button class="mt-2 bg-accent text-blend font-bold rounded-xl px-4 py-2 hover:brightness-110">Daftar</button>
      </form>

      <p class="text-center text-xs text-slate-500">
        Demo ini menyimpan akun di <b>IndexedDB</b>. Session disimpan di <b>cookie</b> selama 7 hari.
      </p>
    </div>
  </main>

  <script>
    // ---------- IndexedDB (Dexie) setup ----------
    const db = new Dexie('travelika');
    db.version(1).stores({
      users: 'email, name, passHash, createdAt' // email jadi primary key
    });

    // ---------- Utils ----------
    const $ = sel => document.querySelector(sel);
    const alertBox = $('#alert');

    function showAlert(msg, type = 'info') {
      alertBox.textContent = msg;
      alertBox.className = '';
      alertBox.classList.add('rounded-lg', 'p-3', 'text-sm');
      if (type === 'error') { alertBox.classList.add('bg-red-50', 'text-red-700', 'border', 'border-red-200'); }
      else if (type === 'success') { alertBox.classList.add('bg-emerald-50', 'text-emerald-700', 'border', 'border-emerald-200'); }
      else { alertBox.classList.add('bg-slate-100', 'text-slate-700', 'border', 'border-slate-200'); }
      alertBox.classList.remove('hidden');
    }
    function hideAlert() { alertBox.classList.add('hidden'); }

    async function sha256(s) {
      const h = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(s));
      return [...new Uint8Array(h)].map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function setSessionCookie(obj, days = 7) {
      const d = new Date(); d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
      let c = `travelika_session=${encodeURIComponent(JSON.stringify(obj))};expires=${d.toUTCString()};path=/;SameSite=Lax`;
      if (location.protocol === 'https:') c += ';Secure';
      document.cookie = c;
    }

    function getNextUrl() {
      const p = new URLSearchParams(location.search);
      return p.get('next') || '/';
    }

    // Storage: minta persistent (biar gak mudah dibersihkan)
    (async () => {
      if (navigator.storage?.persist) {
        const persisted = await navigator.storage.persisted();
        if (!persisted) await navigator.storage.persist();
      }
    })();

    // ---------- Tabs ----------
    const tabLogin = $('#tabLogin'), tabRegister = $('#tabRegister');
    const formLogin = $('#formLogin'), formRegister = $('#formRegister');

    function switchTab(which) {
      hideAlert();
      if (which === 'login') {
        tabLogin.classList.add('bg-white', 'shadow'); tabRegister.classList.remove('bg-white', 'shadow');
        formLogin.classList.remove('hidden'); formRegister.classList.add('hidden');
      } else {
        tabRegister.classList.add('bg-white', 'shadow'); tabLogin.classList.remove('bg-white', 'shadow');
        formRegister.classList.remove('hidden'); formLogin.classList.add('hidden');
      }
    }
    tabLogin.addEventListener('click', () => switchTab('login'));
    tabRegister.addEventListener('click', () => switchTab('register'));

    // ---------- Show/hide password ----------
    document.querySelectorAll('[data-toggle]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.toggle;
        const input = document.getElementById(id);
        input.type = input.type === 'password' ? 'text' : 'password';
        btn.textContent = input.type === 'password' ? 'lihat' : 'sembunyi';
      });
    });

    // ---------- Register ----------
    $('#formRegister').addEventListener('submit', async (e) => {
      e.preventDefault(); hideAlert();
      const name = $('#regName').value.trim();
      const email = $('#regEmail').value.trim().toLowerCase();
      const pass = $('#regPass').value;
      const pass2 = $('#regPass2').value;

      try {
        if (!name) throw new Error('Nama wajib diisi.');
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) throw new Error('Format email tidak valid.');
        if (pass.length < 6) throw new Error('Kata sandi minimal 6 karakter.');
        if (pass !== pass2) throw new Error('Ulangan kata sandi tidak cocok.');

        if (await db.users.get(email)) throw new Error('Email sudah terdaftar.');

        const passHash = await sha256(pass);
        await db.users.put({ email, name, passHash, createdAt: Date.now() });

        showAlert('Pendaftaran berhasil. Anda sudah bisa masuk.', 'success');
        switchTab('login');
        $('#loginEmail').value = email;
        $('#loginPass').value = '';
        $('#loginPass').focus();
      } catch (err) {
        showAlert(err.message || String(err), 'error');
      }
    });

    // ---------- Login ----------
    $('#formLogin').addEventListener('submit', async (e) => {
      e.preventDefault(); hideAlert();
      const email = $('#loginEmail').value.trim().toLowerCase();
      const pass = $('#loginPass').value;
      try {
        const user = await db.users.get(email);
        if (!user) throw new Error('Akun tidak ditemukan.');
        const check = await sha256(pass);
        if (check !== user.passHash) throw new Error('Email atau kata sandi salah.');

        // Session cookie
        setSessionCookie({ email, name: user.name, at: Date.now(), remember: $('#remember').checked });
        showAlert('Berhasil masuk. Mengalihkan...', 'success');
        setTimeout(() => location.href = getNextUrl(), 500);
      } catch (err) {
        showAlert(err.message || String(err), 'error');
      }
    });

    // ---------- Jika sudah login ----------
    (function showIfLoggedIn() {
      const ses = (document.cookie.split('; ').find(r => r.startsWith('travelika_session=')) || '').split('=')[1];
      if (!ses) return;
      try {
        const data = JSON.parse(decodeURIComponent(ses));
        showAlert(`Anda sudah masuk sebagai ${data.name || data.email}.`, 'success');
      } catch { }
    })();

  </script>
  <script src="/components/include-components.js" defer></script>
  <div data-include="/components/footer.html"></div>
</body>

</html>