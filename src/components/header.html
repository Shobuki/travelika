<header
  class="fixed top-0 inset-x-0 h-16 z-30 flex items-center backdrop-blur bg-[rgba(4,27,24,0.40)] border-b border-white/50 text-white">
  <div class="container mx-auto px-4 flex items-center justify-between">
    <a href="/" class="flex items-center gap-2 font-bold">
      <span class="w-2.5 h-2.5 rounded-full bg-accent shadow-[0_0_10px_theme(colors.accent)]"></span>
      Travelika
    </a>

    <nav class="hidden md:flex items-center gap-6 text-sm opacity-90">
      <a href="#destinasi" class="hover:opacity-100">Forests</a>
      <a href="#cara" class="hover:opacity-100">How It Works</a>
      <a href="#keunggulan" class="hover:opacity-100">Benefits</a>

      <!-- Book History (selalu ada; badge hanya saat login) -->
      <a href="/mybookings.html" class="hover:opacity-100 relative flex items-center gap-2">
        Book History
        <span id="navBookCount"
          class="hidden text-[10px] leading-none px-1.5 py-1 rounded-full bg-white/20 border border-white/30">
          0
        </span>
      </a>
    </nav>

    <!-- Area auth; diisi via JS sesuai status login -->
    <div id="authArea">
      <a href="/login">Sign In / Register</a>
    </div>
  </div>
</header>

<script>
  (() => {
    // --- cookie & session helpers ---
    const readCookie = (name) => {
      const v = document.cookie.split("; ").find(r => r.startsWith(name + "="));
      return v ? decodeURIComponent(v.split("=")[1]) : "";
    };
    const getSession = () => {
      try { const raw = readCookie("travelika_session"); return raw ? JSON.parse(raw) : null; }
      catch { return null; }
    };
    const initials = (str) => {
      const s = (str || "").trim();
      if (!s) return "?";
      const parts = s.split(/\s+/);
      const a = (parts[0]?.[0] || "").toUpperCase();
      const b = (parts[1]?.[0] || "").toUpperCase();
      return (a + b) || a || "?";
    };

    // --- Dexie lazy loader (untuk hitung badge) ---
    async function ensureDexie() {
      if (window.Dexie) return;
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = "https://cdn.jsdelivr.net/npm/dexie@4/dist/dexie.min.js";
        s.onload = resolve; s.onerror = reject;
        document.head.appendChild(s);
      });
    }
    async function getMyBookingCount(email) {
      try {
        await ensureDexie();
        const db = new Dexie('travelika');
        db.version(1).stores({ users: 'email, name, passHash, createdAt' });
        db.version(2).stores({
          users: 'email, name, passHash, createdAt',
          bookings: '++id, code, email, createdAt, forest, dateIn, dateOut, pkg'
        });
        if (!email) return 0;
        return await db.bookings.where('email').equals(email).count();
      } catch { return 0; }
    }

    const auth = document.getElementById("authArea");
    const ses = getSession();

    // selalu set URL login agar ada ?next=
    const next = encodeURIComponent(location.pathname + location.search + location.hash);
    const loginUrl = `/login.html?next=${next}`;

    // update link login jika guest
    const loginLink = document.getElementById("loginLink");
    if (loginLink) loginLink.href = loginUrl;

    // Nav badge (default hidden, tampil saat login & count>0)
    const navBookCount = document.getElementById('navBookCount');

    if (!ses) {
      // guest: selesai
      return;
    }

    // --- render state user ---
    const name = ses.name || ses.email;
    const ini = initials(name);

    auth.innerHTML = `
    <div class="relative" id="userWrap">
      <button id="userBtn" class="flex items-center gap-2 px-2 py-1 rounded-full bg-white/10 hover:bg-white/20">
        <span class="w-7 h-7 rounded-full bg-accent text-blend grid place-items-center text-xs font-extrabold">
          ${ini}
        </span>
        <span class="hidden sm:inline max-w-[10rem] truncate">${name}</span>
        <svg class="opacity-80" width="16" height="16" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path d="M5.25 7.5L10 12.25L14.75 7.5H5.25Z"></path>
        </svg>
      </button>

      <div id="userMenu" class="absolute right-0 mt-2 w-52 rounded-xl bg-white text-slate-700 shadow-lg border border-slate-200 hidden overflow-hidden">
        <a href="/" class="block px-3 py-2 hover:bg-slate-50">Beranda</a>
        <a href="#pesan" class="block px-3 py-2 hover:bg-slate-50">Pesan Pass</a>
        <a href="/mybookings.html" class="block px-3 py-2 hover:bg-slate-50 flex items-center justify-between">
          <span>Book History</span>
          <span id="menuBookCount" class="hidden text-[10px] leading-none px-1.5 py-1 rounded-full bg-slate-100 border border-slate-200">0</span>
        </a>
        <button id="logoutBtn" class="w-full text-left px-3 py-2 hover:bg-slate-50 text-red-600">Keluar</button>
      </div>
    </div>
  `;

    // --- interaksi dropdown & logout ---
    const btn = document.getElementById("userBtn");
    const menu = document.getElementById("userMenu");
    const out = document.getElementById("logoutBtn");
    const menuBookCount = document.getElementById('menuBookCount');

    btn?.addEventListener("click", (e) => {
      e.stopPropagation();
      menu?.classList.toggle("hidden");
    });
    document.addEventListener("click", () => menu?.classList.add("hidden"));

    out?.addEventListener("click", () => {
      // hapus cookie sesi
      document.cookie = "travelika_session=; Max-Age=0; path=/; SameSite=Lax" + (location.protocol === "https:" ? "; Secure" : "");
      location.reload();
    });

    // --- tampilkan badge count booking milik user ---
    (async () => {
      const cnt = await getMyBookingCount(ses.email);
      if (cnt > 0) {
        if (navBookCount) { navBookCount.textContent = cnt; navBookCount.classList.remove('hidden'); }
        if (menuBookCount) { menuBookCount.textContent = cnt; menuBookCount.classList.remove('hidden'); }
      }
    })();
  })();
</script>